<?xml version="1.0" encoding="utf-8"?>
<mx:Application 
	xmlns:mx="http://www.adobe.com/2006/mxml" 
	xmlns:mlc="com.matlabulchifai.components.views.*" 
	layout="absolute"
	backgroundGradientColors="[#007D0B, #FFFFFF]"
	horizontalAlign="center"
	verticalAlign="top"
	paddingLeft="0"
	paddingRight="0"
	paddingTop="0"
	paddingBottom="0"
	width="100%"
	height="100%"
	creationComplete="handleCreationComplete()">
	
	<mx:Script>
		<![CDATA[
			import mx.controls.Button;
		import com.matlabulchifai.events.login.*;
		import com.matlabulchifai.components.views.DebugPanel;
		import com.matlabulchifai.util.DebugMessage;
		import mx.events.MenuEvent;
		import mx.events.ListEvent;
	    import mx.controls.Alert;
	    import mx.rpc.events.ResultEvent;
	    import mx.collections.IViewCursor;
	    import com.matlabulchifai.events.alert.AlertEvent;
		
		[Bindable]
		private var _user:XML;
		
		[Bindable]
		public static var title:String = "";
		
		[Bindable]
		private var patientIdMap:Object;
		
		public static function debug(str:String):void {
			application.debugPanel.addMessage(
			new DebugMessage(str));
		}		
		
		private function updatePatientIdMap():void {
	    	patientIdMap = {};
	        var patientsCursor:IViewCursor =
	            patientsXLC.createCursor();
	        while (!patientsCursor.afterLast) {
	            var patient:XML = XML(patientsCursor.current);
	            patientIdMap[patient.id] = patient;
	            patientsCursor.moveNext();
	        }
	    }
		
		private function handleCreationComplete():void{
			mainMenu.addEventListener(MouseEvent.CLICK, handleMenuClick);
			svcPatientList.send();
		}
		
		private function handleLogin(e:LoginEvent):void{
			login(e.user);
		}
		
		private function handleAccountCreate(e:AccountCreateEvent):void{
			login(e.user);
		}
		
		private function login(user:XML):void{
			_user = user;
			debug("user = " + user);
			mainStack.selectedChild = alertBox;
			title = "Alerts"
			mainMenu.visible = true;
		}
		
		private function handleLogout():void{
			// invalidate session by invoking ruby logout, possibly attach event to login box and handle there
			mainMenu.visible = false;
			mainStack.selectedChild = loginBox;
		}
		
		private function handleMenuClick(e:MouseEvent):void {
			if(e.currentTarget.selectedIndex == 0) {
				mainStack.selectedChild = alertBox;
				title = "Alerts";	
			}
			else if(e.currentTarget.selectedIndex == 1) {
				mainStack.selectedChild = patientBox;
				title = "Patients";
			}
			else if(e.currentTarget.selectedIndex == 2) {
				mainStack.selectedChild = adminBox;
				title = "Administration";
			}
			else if(e.currentTarget.selectedIndex == 3) {
				handleLogout();
				title = "";
			}
			mainMenu.selectedIndex = -1;
		}
		
		private function handlePatientListResult(event:ResultEvent):void {
			var resultXML: XML = XML(event.result);
			updatePatientIdMap();
			debug("patients = \n" + resultXML);	
		}
		
		]]>
	</mx:Script>
	
	<mx:HTTPService
        id="svcPatientList"
        url="/patients.xml"
        resultFormat="e4x"
        result="handlePatientListResult(event)"/>
    <mx:XMLListCollection 
    	id="patientsXLC"
    	source="{XMLList(svcPatientList.lastResult.children())}"/>
	
<mx:VDividedBox width="100%" height="100%">
	<mx:VBox height="100%" width="100%">
		<mx:Canvas width="100%" height="75">
				<mx:VBox height="100%" width="100%" horizontalAlign="center">
					<mx:Text height="100%" width="100%" fontFamily="Comic Sans MS" fontSize="55" color="white" text="Matlabul Chifai"/>
				</mx:VBox>
		</mx:Canvas>
		<mx:MenuBar id="mainMenu" width="100%" labelField="@label" visible="false" >
			<mx:XMLList>
	            <menuitem label="Alerts"/>
	            <menuitem label="Patients"/>
	            <menuitem label="Administration"/>
	            <menuitem label="Logout"/>
	        </mx:XMLList>
		</mx:MenuBar>
		<mx:Text id="titleText" fontFamily="Comic Sans MS" fontSize="24" fontWeight="bold" 
			color="white" letterSpacing="2" fontThickness="10" text="{title}  "/>
		<mx:ViewStack id="mainStack" width="100%" height="100%">
			<mx:VBox id="loginBox">
				<mlc:LoginBox id="loginFormBox" login="handleLogin(event)"/>
				<mx:Button click="mainStack.selectedChild=patientBox;title='Patients';mainMenu.visible=true;" label="Bypass Login"/>
				<mx:Button click="mainStack.selectedChild=patientInfoBox;title='Patient Summary';mainMenu.visible=true;" label="Patient Summary"/>
				<mlc:AccountCreateBox id="accountCreateBox" accountCreate="handleAccountCreate(event)"/>
			</mx:VBox>
			<mx:HBox id="alertBox">
				<mlc:AlertGridBox id="alertGridBox"
					patientsXLC="{patientsXLC}"
					patientIdMap="{patientIdMap}" 
					width="70%" height="90%" horizontalAlign="left"/>
				<mlc:AlertCreateBox id="alertCreateBox"
					alertCreate="alertGridBox.listAlerts()"
					patientsXLC="{patientsXLC}" 
					width="30%" height="90%" horizontalAlign="center"/>	
			</mx:HBox>
			<mx:HBox id="patientBox">
				<mlc:PatientGridBox id="patientGridBox"
					mainStackVar="{mainStack}"
					patientInfoBoxVar="{patientInfoBox}"
					width="70%" height="90%" horizontalAlign="left"/>
				<mlc:PatientCreateBox id="patientCreateBox"
					patientCreate="patientGridBox.listPatients()"
					width="30%" height="90%" horizontalAlign="center"/>	
			</mx:HBox>
			<mlc:AdminBox id="adminBox"/>
			<mlc:PatientInfo id="patientInfoBox"
					patientIdMap="{patientIdMap}" />
		</mx:ViewStack>
	</mx:VBox>
	<mlc:DebugPanel id="debugPanel" width="100%" height="0%"/>
</mx:VDividedBox>
	
</mx:Application>
