<?xml version="1.0" encoding="utf-8"?>
<mx:HBox 
	xmlns:mx="http://www.adobe.com/2006/mxml" 
	width="100%" 
	height="100%"
    label="PatientInfo"
	show="init()">
<mx:Script>
<![CDATA[
	import com.matlabulchifai.components.popups.AlertCreateTitleWin;
	import flash.events.Event;
	import mx.core.IFlexDisplayObject;
	import mx.rpc.events.ResultEvent;
	import mx.collections.XMLListCollection;
	import mx.managers.PopUpManager;
	import com.matlabulchifai.components.popups.VaccCreateTitleWin;
	import com.matlabulchifai.components.popups.AllergyCreateTitleWin;
	import com.matlabulchifai.components.popups.NoteCreateTitleWin;
	import com.matlabulchifai.components.popups.VisitCreateTitleWin;
	import com.matlabulchifai.components.popups.PrescriptionCreateTitleWin;
	import com.matlabulchifai.events.patient.VaccinationEvent;
	import com.matlabulchifai.events.patient.AllergyEvent;
	import com.matlabulchifai.events.patient.VisitEvent;
	import com.matlabulchifai.events.patient.NoteEvent;
	import com.matlabulchifai.events.patient.PrescriptionEvent;
	import com.matlabulchifai.events.patient.AlertEvent;
	
	[Bindable]
	public var languageArray:Object;
	[Bindable]
	public var patientID:Number = 0;
	
	[Bindable]
	public var patient:XML;
	
	private var rnd:Number;
	private var vaccPopUp:VaccCreateTitleWin;
	private var allergyPopUp:AllergyCreateTitleWin;
	private var visitPopUp:VisitCreateTitleWin;
	private var notePopUp:NoteCreateTitleWin;
	private var prescriptionPopUp:PrescriptionCreateTitleWin;
	private var alertPopUp:AlertCreateTitleWin;
	
	public function init():void {
		patientID = patient.id;
    	rnd = Math.round(Math.random()*1000);
		listAlerts();
		patientInfoMain.selectedIndex = 0;			
	}
	
	public function listAlerts():void {
		svcAlertsList.url="/patients/" + patientID + "/patient_alerts.xml?";
		svcAlertsList.send();
	}
	
	public function listPrescriptions():void {
		svcPrescriptionsList.url="/patients/" + patientID + "/patient_medications.xml?";
		svcPrescriptionsList.send();
	}
	
	private function handlePrescriptionsListResult(event:ResultEvent):void {
		var resultXML:XML = XML(event.result);
		Matlabulchifai.debug("prescriptions_notes = \n" + resultXML);
	}
	
	public function listNotes():void {
		svcNotesList.url="/patients/" + patientID + "/patient_notes.xml?";
		svcNotesList.send();
	}
	
	private function handleNotesListResult(event:ResultEvent):void {
		var resultXML:XML = XML(event.result);
		Matlabulchifai.debug("patient_notes = \n" + resultXML);
	}
	
	
	public function listVaccinations():void {
		svcVaccinationsList.url="/patients/" + patientID + "/patient_vaccinations.xml?patient_id=" + patientID;
		svcVaccinationsList.send();
	}
	
	private function handleVaccinationsListResult(event:ResultEvent):void {
		var resultXML:XML = XML(event.result);
		Matlabulchifai.debug("patient_vaccinations = \n" + resultXML);
	}
	
	public function listAllergies():void {
		svcAllergiesList.url="/patients/" + patientID + "/patient_allergies.xml?patient_id=" + patientID;
		svcAllergiesList.send();
	}
	
	private function handleAllergiesListResult(event:ResultEvent):void {
		var resultXML:XML = XML(event.result);
		Matlabulchifai.debug("patient_allergies = \n" + resultXML);
	}
	
	public function listVisits():void {
		svcVisitsList.url="/patients/" + patientID + "/patient_visits.xml?";
		svcVisitsList.send();
	}
	
	private function handleVisitsListResult(event:ResultEvent):void {
		var resultXML:XML = XML(event.result);
		Matlabulchifai.debug("visit_allergies = \n" + resultXML);
	}
	
	private function showVaccCreateTitleWin():void {
		vaccPopUp = VaccCreateTitleWin(PopUpManager.createPopUp(this, VaccCreateTitleWin, true));
		vaccPopUp.addEventListener(VaccinationEvent.VACCINATION_CREATE, handleVaccEvent);
		vaccPopUp.patient = this.patient;
		vaccPopUp.patientID = this.patientID;
		PopUpManager.centerPopUp(vaccPopUp);
	}
	
	public function handleVaccEvent(event:Event):void {
		listVaccinations();
		removeVaccEventListener();
	}
	
	public function removeVaccEventListener():void {
		if (vaccPopUp.hasEventListener(VaccinationEvent.VACCINATION_CREATE)) {
			vaccPopUp.removeEventListener(VaccinationEvent.VACCINATION_CREATE, handleVaccEvent);
		}
	}
	
	private function showAllergyCreateTitleWin():void{
		allergyPopUp = AllergyCreateTitleWin(PopUpManager.createPopUp(this, AllergyCreateTitleWin, true));
		allergyPopUp.addEventListener(AllergyEvent.ALLERGY_CREATE, handleAllergyEvent);
		allergyPopUp.patient = this.patient;
		allergyPopUp.patientID = this.patientID;
		PopUpManager.centerPopUp(allergyPopUp);
	}
	
	public function handleAllergyEvent(event:Event):void {
		listAllergies();
		removeAllergyEventListener();
	}
	
	public function removeAllergyEventListener():void {
		if (allergyPopUp.hasEventListener(AllergyEvent.ALLERGY_CREATE)) {
			allergyPopUp.removeEventListener(AllergyEvent.ALLERGY_CREATE, handleAllergyEvent);
		}
	}
	
	private function showVisitCreateTitleWin():void {
		visitPopUp = VisitCreateTitleWin(PopUpManager.createPopUp(this, VisitCreateTitleWin, true));
		visitPopUp.addEventListener(VisitEvent.VISIT_CREATE, handleVisitEvent);
		visitPopUp.patient = this.patient;
		visitPopUp.patientID = this.patientID;
		PopUpManager.centerPopUp(visitPopUp);
	}
	
	public function handleVisitEvent(event:Event):void {
		listVisits();
		removeVisitEventListener();
	}
	
	public function removeVisitEventListener():void {
		if (visitPopUp.hasEventListener(VisitEvent.VISIT_CREATE)) {
			visitPopUp.removeEventListener(VisitEvent.VISIT_CREATE, handleVisitEvent);
		}
	}
	
	private function showNoteCreateTitleWin():void {				
		notePopUp = NoteCreateTitleWin(PopUpManager.createPopUp(this, NoteCreateTitleWin, true));
		notePopUp.addEventListener(NoteEvent.NOTE_CREATE, handleNoteEvent);
		notePopUp.patient = this.patient;
		notePopUp.patientID = this.patientID;
		PopUpManager.centerPopUp(notePopUp);
	}
	
	public function handleNoteEvent(event:Event):void {
		listNotes();				
		removeNoteEventListener();			
	}						
	
	public function removeNoteEventListener():void {				
		if (notePopUp.hasEventListener(NoteEvent.NOTE_CREATE)) {					
			notePopUp.removeEventListener(NoteEvent.NOTE_CREATE, handleNoteEvent);				
		}			
	}						
	
	private function showPrescriptionCreateTitleWin():void {				    			
		prescriptionPopUp = PrescriptionCreateTitleWin(PopUpManager.createPopUp(this, PrescriptionCreateTitleWin, true));    			
		prescriptionPopUp.addEventListener(PrescriptionEvent.PRESCRIPTION_CREATE, handlePrescriptionEvent);    			
		prescriptionPopUp.patient = this.patient;				
		prescriptionPopUp.patientID = this.patientID;    			
		PopUpManager.centerPopUp(prescriptionPopUp);    		
	}						
	
	public function handlePrescriptionEvent(event:Event):void {				
		listPrescriptions();				
		removePrescriptionEventListener();			
	}						
	
	public function removePrescriptionEventListener():void {				
		if (prescriptionPopUp.hasEventListener(PrescriptionEvent.PRESCRIPTION_CREATE)) {					
			prescriptionPopUp.removeEventListener(PrescriptionEvent.PRESCRIPTION_CREATE, handlePrescriptionEvent);				
		}			
	}	
	
	private function showAlertCreateTitleWin():void {				
		alertPopUp = AlertCreateTitleWin(PopUpManager.createPopUp(this, AlertCreateTitleWin, true));
		alertPopUp.patient = this.patient;
		alertPopUp.patientID = this.patientID;
		alertPopUp.languageArray = languageArray;
		PopUpManager.centerPopUp(alertPopUp);
		alertPopUp.addEventListener(AlertEvent.ALERT_CREATE, handleAlertEvent);
	}
	
	public function handleAlertEvent(event:Event):void {
		dispatchEvent(new AlertEvent(AlertEvent.ALERT_CREATE, null));
		listAlerts();				
		removeAlertEventListener();			
	}						
	
	public function removeAlertEventListener():void {				
		if (alertPopUp.hasEventListener(AlertEvent.ALERT_CREATE)) {					
			alertPopUp.removeEventListener(AlertEvent.ALERT_CREATE, handleNoteEvent);				
		}			
	}								    	
]]>
</mx:Script>
	
	
	<mx:HTTPService
        id="svcVaccinationsList"
        resultFormat="e4x"
        result="handleVaccinationsListResult(event)"/>
	<mx:XMLListCollection id="vaccinationsXLC"
        source="{XMLList(svcVaccinationsList.lastResult.children())}"/>
	
	<mx:HTTPService
        id="svcAllergiesList"
        resultFormat="e4x"
        result="handleAllergiesListResult(event)"/>
	<mx:XMLListCollection id="allergiesXLC"
        source="{XMLList(svcAllergiesList.lastResult.children())}"/>

	<mx:HTTPService
        id="svcVisitsList"
        resultFormat="e4x"
        result="handleVisitsListResult(event)"/>
	<mx:XMLListCollection id="visitsXLC"
        source="{XMLList(svcVisitsList.lastResult.children())}"/>
		
	<mx:HTTPService
        id="svcNotesList"
        resultFormat="e4x"
        result="handleNotesListResult(event)"/>
	<mx:XMLListCollection id="notesXLC"
        source="{XMLList(svcNotesList.lastResult.children())}"/>
		
	<mx:HTTPService
        id="svcPrescriptionsList"
        resultFormat="e4x"
        result="handlePrescriptionsListResult(event)"/>
	<mx:XMLListCollection id="prescriptionsXLC"
        source="{XMLList(svcPrescriptionsList.lastResult.children())}"/>
    
    <mx:HTTPService
        id="svcAlertsList"
        resultFormat="e4x"
        result=""/>
	<mx:XMLListCollection id="alertsXLC"
        source="{XMLList(svcAlertsList.lastResult.children())}"/>
		
	<mx:VBox label="Main" height="100%" width="20%">
		<mx:Label text="{patient['first_name']} {patient['last_name']}" fontSize="36" color="#171712"/>
		<mx:Image source="http://parentalwisdom.files.wordpress.com/2007/08/einstein.png"/>			
	</mx:VBox>
   	<mx:VBox height="100%" width="80%" verticalGap="0">
   		<mx:TabBar dataProvider="{patientInfoMain}" 
   			fontWeight="Bold" paddingTop="0" paddingBottom="0" />			
   		<mx:ViewStack 
   			id="patientInfoMain" 
   			width="100%" 
   			height="100%">
	   		<mx:VBox label="{languageArray['Alerts']}" show="listAlerts()">
	   			<mx:Panel title="{languageArray['Alert List']}" width="100%" height="100%" 
	   				paddingTop="5" paddingLeft="5" paddingRight="5">
		   			<mx:LinkButton label="{languageArray['Add New Alert']}" color="#0000FF" click="showAlertCreateTitleWin()"/>
		   			<mx:DataGrid id="alertsGrid" width="100%" height="100%" textAlign="center" 
		   				dataProvider="{alertsXLC}" wordWrap="true" variableRowHeight="true">						
		   				<mx:columns>														
		   					<mx:DataGridColumn headerText="{languageArray['Alert Date']}" 
		   						dataField="alert_date" width="90"/>							
		   					<mx:DataGridColumn headerText="{languageArray['Alert Note']}" 
		   						dataField="notes"/>						
		   				</mx:columns>					
		   			</mx:DataGrid>
	   			</mx:Panel>
	   		</mx:VBox>
	   		<mx:VBox label="{languageArray['General Information']}" show="">
	   			<mx:Panel title="{languageArray['General Information']}" width="100%" height="100%" 
	   				paddingTop="10" paddingLeft="5" paddingRight="5">									
					<mx:HBox>
						<mx:Label text="{languageArray['Medical Record ID']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['medical_record_number']}" fontSize="12"/>				
					</mx:HBox>
					<mx:HBox>
						<mx:Label text="{languageArray['Patient Name']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['first_name'] + ' ' + patient['middle_name'] + ' ' + patient['last_name']}" fontSize="12"/>
					</mx:HBox>
					<mx:HBox>
						<mx:Label text="{languageArray['Date of Birth']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['date_of_birth']}" fontSize="12"/>
					</mx:HBox>
					<mx:HBox>
						<mx:Label text="{languageArray['Arrival Date']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['arrival_date']}" fontSize="12"/>
					</mx:HBox>
					<mx:HBox>
						<mx:Label text="{languageArray['Gender']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['gender']}" fontSize="12"/>
					</mx:HBox>
					<mx:Spacer height="20" />
					<mx:HBox>
						<mx:Label text="{languageArray['Address']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['address'] + ' ' + patient['city'] + ' ' + patient['state'] + ' ' + patient['zip']}" fontSize="12"/>
					</mx:HBox>
					<mx:HBox>
						<mx:Label text="{languageArray['Telephone']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['telephone']}" fontSize="12"/>
					</mx:HBox>
					<mx:HBox>
						<mx:Label text="{languageArray['Father Name']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['father_first_name'] + ' ' + patient['father_last_name']}" fontSize="12"/>
					</mx:HBox>
					<mx:HBox>
						<mx:Label text="{languageArray['Mother Name']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['mother_first_name'] + ' ' + patient['mother_last_name']}" fontSize="12"/>
					</mx:HBox>
					<mx:Spacer height="20" />
					<mx:HBox>
						<mx:Label text="{languageArray['Emergency Contact Name']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['emergency_contact_name']}" fontSize="12"/>
					</mx:HBox>
					<mx:HBox>
						<mx:Label text="{languageArray['Emergency Contact Relationship']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['emergency_contact_relationship']}" fontSize="12"/>
					</mx:HBox>
					<mx:HBox>
						<mx:Label text="{languageArray['Emergency Contact Number']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['emergency_contact_number']}" fontSize="12"/>
					</mx:HBox>
					<mx:Spacer height="20" />
					<mx:HBox>
						<mx:Label text="{languageArray['Notes']}:" fontSize="12" fontWeight="bold"/>
						<mx:Label text="{patient['notes']}" fontSize="12"/>
					</mx:HBox>
	   			</mx:Panel>
	   		</mx:VBox>
	   		<mx:VBox label="{languageArray['Notes']}" show="listNotes()">
	   			<mx:Panel title="{languageArray['Note List']}" width="100%" height="100%" 
	   				paddingTop="5" paddingLeft="5" paddingRight="5">
		   			<mx:LinkButton label="{languageArray['Add New Note']}" color="#0000FF" click="showNoteCreateTitleWin()"/>
		   			<mx:DataGrid id="notesGrid" width="100%" height="100%" textAlign="center" 
		   				dataProvider="{notesXLC}" wordWrap="true" variableRowHeight="true">						
		   				<mx:columns>														
		   					<mx:DataGridColumn headerText="{languageArray['Note Date']}" 
		   						dataField="note_date" width="90"/>							
		   					<mx:DataGridColumn headerText="{languageArray['Note']}" 
		   						dataField="body"/>						
		   				</mx:columns>					
		   			</mx:DataGrid>
	   			</mx:Panel>
	   		</mx:VBox>										
	   		<mx:VBox label="{languageArray['Prescriptions']}" show="listPrescriptions()">					
	   			<mx:DataGrid id="prescriptionsGrid" width="100%" height="100%" textAlign="center" dataProvider="{prescriptionsXLC}">						
		   			<mx:columns>														
		   				<mx:DataGridColumn headerText="{languageArray['Name']}" dataField="name"/>							
		   				<mx:DataGridColumn headerText="{languageArray['Dosage']}" dataField="dosage"/>							
		   				<mx:DataGridColumn headerText="{languageArray['Frequency']}" dataField="frequency"/>							
		   				<mx:DataGridColumn headerText="{languageArray['Date Given']}" dataField="dateGiven"/>						
		   			</mx:columns>					
	   			</mx:DataGrid>					
	   			<mx:LinkButton label="{languageArray['Add New Prescription']}" color="#0000FF" click="showPrescriptionCreateTitleWin()" />				
	   		</mx:VBox>								
	   		<mx:VBox label="{languageArray['Visits']}" show="listVisits()">					
	   			<mx:DataGrid id="visitsGrid" width="100%" height="100%" textAlign="center" dataProvider="{visitsXLC}">						
	   				<mx:columns>							
	   					<mx:DataGridColumn headerText="{languageArray['Reason']}" dataField="reason"/>							
	   					<mx:DataGridColumn headerText="{languageArray['Date Seen']}" dataField="dateSeen"/>							
	   					<mx:DataGridColumn headerText="{languageArray['Follow Up']}" dataField="followUp"/>							
	   					<mx:DataGridColumn headerText="{languageArray['Notes']}" dataField="notes"/>						
	   				</mx:columns>					
	   			</mx:DataGrid>					
	   			<mx:LinkButton label="{languageArray['Add new visit']}" color="#0000FF" click="showVisitCreateTitleWin()" />				
	   		</mx:VBox>				
	   		<mx:VBox label="{languageArray['Allergies']}" show="listAllergies()">				
	   			<mx:DataGrid id="allergiesGrid" width="100%" height="100%" textAlign="center" dataProvider="{allergiesXLC}">					
	   				<mx:columns>					
	   					<mx:DataGridColumn headerText="{languageArray['Name']}"	dataField="name"/>	
	   					<mx:DataGridColumn headerText="{languageArray['Date Observed']}" dataField="date_observed"/>							
	   					<mx:DataGridColumn headerText="{languageArray['Severity']}"	dataField="severity"/>						
	   					<mx:DataGridColumn headerText="{languageArray['Notes']}" dataField="notes"/>						
	   				</mx:columns>					
	   			</mx:DataGrid>					
	   			<mx:LinkButton label="{languageArray['Add new allergy']}" color="#0000FF" click="showAllergyCreateTitleWin()"/>				
	   		</mx:VBox>				
	   		<mx:VBox label="{languageArray['Vaccinations']}" show="listVaccinations()">					
	   			<mx:DataGrid id="vaccinationsGrid" width="100%" height="100%" textAlign="center" dataProvider="{vaccinationsXLC}">						
	   				<mx:columns>							
	   					<mx:DataGridColumn headerText="{languageArray['Name']}"	dataField="name"/>							
	   					<mx:DataGridColumn headerText="{languageArray['Date Administered']}" dataField="date_admined"/>							
	   					<mx:DataGridColumn headerText="{languageArray['Notes']}" dataField="notes"/>						
	   				</mx:columns>					
	   			</mx:DataGrid>					
	   			<mx:LinkButton label="{languageArray['Add new vaccination']}" color="#0000FF" click="showVaccCreateTitleWin()"/>				
	   		</mx:VBox>			
   		</mx:ViewStack>		
   	</mx:VBox>		
</mx:HBox>