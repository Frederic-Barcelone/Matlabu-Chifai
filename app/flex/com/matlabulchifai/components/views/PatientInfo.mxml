<?xml version="1.0" encoding="utf-8"?>
<mx:VBox 
	xmlns:mx="http://www.adobe.com/2006/mxml" 
	width="100%" 
	height="100%"
    label="PatientInfo"
	creationComplete="summary()">
    <mx:Script>
    	<![CDATA[
    		import mx.core.IFlexDisplayObject;
    		import mx.rpc.events.ResultEvent;
			import mx.collections.XMLListCollection;
			import mx.managers.PopUpManager;
			import com.matlabulchifai.components.popups.VaccCreateTitleWin;
			import com.matlabulchifai.components.popups.AllergyCreateTitleWin;
			import com.matlabulchifai.components.popups.NoteCreateTitleWin;
			import com.matlabulchifai.components.popups.VisitCreateTitleWin;
			
    		[Bindable]
    		public var patientID:Number;
    		[Bindable]
    		public var patientIdMap:Object;
    		[Bindable]
    		public var patient:XML;
			[Bindable]
			public var notesXLC:XMLListCollection;
    		
    		public function init(idnum:int):void{
    			patientID=idnum;    			
    			//Patient info
    			patient = patientIdMap[idnum];
    	    		
    		}
			
			public function summary():void {
				listAllergies();
				listVisits();
				listVaccinations();
			}
			
			public function listVaccinations():void {
				svcVaccinationsList.url="/vaccinations.xml?patient_id=" + patientID;
				svcVaccinationsList.send();
			}
    		
			private function handleVaccinationsListResult(event:ResultEvent):void {
				var resultXML:XML = XML(event.result);
				Matlabulchifai.debug("patient_vaccinations = \n" + resultXML);
			}
			
			public function listAllergies():void {
				svcAllergiesList.url="/allergies.xml?patient_id=" + patientID;
				svcAllergiesList.send();
			}
    		
			private function handleAllergiesListResult(event:ResultEvent):void {
				var resultXML:XML = XML(event.result);
				Matlabulchifai.debug("patient_allergies = \n" + resultXML);
			}
			
			public function listVisits():void {
				svcVisitsList.url="/visits.xml?patient_id=" + patientID;
				svcVisitsList.send();
			}
    		
			private function handleVisitsListResult(event:ResultEvent):void {
				var resultXML:XML = XML(event.result);
				Matlabulchifai.debug("visit_allergies = \n" + resultXML);
			}
			
    		private function showVaccCreateTitleWin():void{
    			var vaccPopUp:VaccCreateTitleWin = 
    				VaccCreateTitleWin(PopUpManager.createPopUp(this, VaccCreateTitleWin, true));
    			
    			vaccPopUp.patient = this.patient;
				vaccPopUp.patientID = this.patientID;
    			PopUpManager.centerPopUp(vaccPopUp);
    		}
			
			private function showAllergyCreateTitleWin():void{
    			var allergyPopUp:AllergyCreateTitleWin = 
    				AllergyCreateTitleWin(PopUpManager.createPopUp(this, AllergyCreateTitleWin, true));
    			
    			allergyPopUp.patient = this.patient;
				allergyPopUp.patientID = this.patientID;
    			PopUpManager.centerPopUp(allergyPopUp);
    		}
			
			private function showVisitCreateTitleWin():void{
    			var visitPopUp:VisitCreateTitleWin = 
    				VisitCreateTitleWin(PopUpManager.createPopUp(this, VisitCreateTitleWin, true));
    			
    			visitPopUp.patient = this.patient;
				visitPopUp.patientID = this.patientID;
    			PopUpManager.centerPopUp(visitPopUp);
    		}
			
			private function showNoteCreateTitleWin():void{
    			var notePopUp:NoteCreateTitleWin = 
    				NoteCreateTitleWin(PopUpManager.createPopUp(this, NoteCreateTitleWin, true));
    			
    			notePopUp.patient = this.patient;
    			PopUpManager.centerPopUp(notePopUp);
    			
    			// might want to raise event within vacc title window so PatientInfo
    			// knows to refresh the datagrid after successful entry
    		}
    		[Bindable]
			public var languageArray:Object;
    	]]>
    </mx:Script>
	
	
	<mx:HTTPService
        id="svcVaccinationsList"
        resultFormat="e4x"
        result="handleVaccinationsListResult(event)"/>
	
	<mx:XMLListCollection id="vaccinationsXLC"
        source="{XMLList(svcVaccinationsList.lastResult.children())}"/>
	
	<mx:HTTPService
        id="svcAllergiesList"
        resultFormat="e4x"
        result="handleAllergiesListResult(event)"/>
	
	<mx:XMLListCollection id="allergiesXLC"
        source="{XMLList(svcAllergiesList.lastResult.children())}"/>

	<mx:HTTPService
        id="svcVisitsList"
        resultFormat="e4x"
        result="handleVisitsListResult(event)"/>
	
	<mx:XMLListCollection id="visitsXLC"
        source="{XMLList(svcVisitsList.lastResult.children())}"/>
    <mx:Label text="{patient['first_name']} {patient['last_name']}" fontSize="36" color="#171712"/>
    <mx:HBox label="Main">
    	<mx:VBox>
    		<mx:Image source="http://parentalwisdom.files.wordpress.com/2007/08/einstein.png"/>	
    	</mx:VBox>
		<mx:VBox>			<mx:Label text="{languageArray['General Information']}"  fontWeight="bold" fontSize="12"/>			<mx:HBox>
				<mx:Label text="{languageArray['Patient ID']}: {patient['id']}"  fontSize="12"/>				<mx:Label text="{languageArray['Patient Active']}: {patient['patient_active']}"  fontSize="12"/>			</mx:HBox>
			<mx:HBox>
				<mx:Label text="{languageArray['First Name']}: {patient['first_name']}"  fontSize="12"/>				<mx:Label text="{languageArray['Middle Name']}: {patient['middle_name']}"  fontSize="12"/>				<mx:Label text="{languageArray['Last Name']}: {patient['last_name']}"  fontSize="12"/>			</mx:HBox>
			<mx:HBox>
				<mx:Label text="{languageArray['Date of Birth']}: {patient['date_of_birth']}"  fontSize="12"/>
				<mx:Label text="{languageArray['Gender']}: {patient['gender']}"  fontSize="12"/>
			</mx:HBox>
			<mx:HBox>
				<mx:Label text="{languageArray['Address']}: {patient['address']}"  fontSize="12"/>
				<mx:Label text="{languageArray['City']}: {patient['city']}"  fontSize="12"/>
			</mx:HBox>
			<mx:HBox>
				<mx:Label text="{languageArray['Father First Name']}: {patient['father_first_name']}"  fontSize="12"/>
				<mx:Label text="{languageArray['Father Last Name']}: {patient['father_last_name']}"  fontSize="12"/>
			</mx:HBox>
			<mx:HBox>
				<mx:Label text="{languageArray['Mother First Name']}: {patient['mother_first_name']}"  fontSize="12"/>
				<mx:Label text="{languageArray['Mother Last Name']}: {patient['mother_last_name']}"  fontSize="12"/>
			</mx:HBox>
			<mx:Label />
			
			<mx:Label text="{languageArray['Emergency Contact']}"  fontWeight="bold" fontSize="12"/>
			<mx:HBox>
	    		<mx:Label text="{languageArray['First Name']}: {patient['emergency_first_name']}"  fontSize="12"/>
				<mx:Label text="{languageArray['Middle Name']}: {patient['emergency_middle_name']}"  fontSize="12"/>
				<mx:Label text="{languageArray['Last Name']}: {patient['emergency_last_name']}"  fontSize="12"/>
			</mx:HBox>
			<mx:HBox>
				<mx:Label text="{languageArray['Date of Birth']}: {patient['date_of_birth']}"  fontSize="12"/>
				<mx:Label text="{languageArray['Gender']}: {patient['gender']}"  fontSize="12"/>
			</mx:HBox>
			<mx:HBox>
				<mx:Label text="{languageArray['Address']}: {patient['address']}"  fontSize="12"/>
				<mx:Label text="{languageArray['City']}: {patient['city']}"  fontSize="12"/>
			</mx:HBox>
			<mx:Label />
		</mx:VBox>
   		<mx:VBox width="600" height="500">   			<mx:TabBar dataProvider="{pateientInfoMain}" fontWeight="Bold" x="51" y="3" />			<mx:ViewStack horizontalCenter="0" y="30" id="pateientInfoMain" width="95%" height="87%" borderStyle="solid">	    		<mx:VBox label='Notes'>						<mx:DataGrid id="notesGrid" width="100%" height="100%" textAlign="center" 								dataProvider="{notesXLC}">								<mx:columns>									<mx:DataGridColumn headerText="Note" dataField="note"/>								</mx:columns>							</mx:DataGrid>					<mx:LinkButton label="{languageArray['Add new note']}" color="#0000FF" click="showNoteCreateTitleWin()"/>		    	</mx:VBox>		    	<mx:VBox label="Visits">						<mx:DataGrid id="visitsGrid" width="100%" height="100%" textAlign="center" 							dataProvider="{visitsXLC}">							<mx:columns>								<mx:DataGridColumn headerText="{languageArray['Reason']}"									dataField="reason"/>								<mx:DataGridColumn headerText="{languageArray['Date Seen']}"									dataField="dateSeen"/>								<mx:DataGridColumn headerText="{languageArray['Follow Up']}"									dataField="followUp"/>								<mx:DataGridColumn headerText="{languageArray['Notes']}"									dataField="notes"/>							</mx:columns>						</mx:DataGrid>					<mx:LinkButton label="{languageArray['Add new visit']}" color="#0000FF" click="showVisitCreateTitleWin()" />		    	</mx:VBox>		    	<mx:VBox label='Allergies'>						<mx:DataGrid id="allergiesGrid" width="100%" height="100%" textAlign="center" 							dataProvider="{allergiesXLC}">							<mx:columns>								<mx:DataGridColumn headerText="{languageArray['Name']}"									dataField="name"/>								<mx:DataGridColumn headerText="{languageArray['Date Observed']}"									dataField="dateObserved"/>								<mx:DataGridColumn headerText="{languageArray['Severity']}"									dataField="severity"/>								<mx:DataGridColumn headerText="{languageArray['Notes']}"									dataField="notes"/>							</mx:columns>						</mx:DataGrid>					<mx:LinkButton label="{languageArray['Add new allergy']}" color="#0000FF" click="showAllergyCreateTitleWin()"/>				</mx:VBox>		    	<mx:VBox label='Vaccinations'>						<mx:DataGrid id="vaccinationsGrid" width="100%" height="100%" textAlign="center" 							dataProvider="{vaccinationsXLC}">							<mx:columns>								<mx:DataGridColumn headerText="{languageArray['Name']}"									dataField="name"/>								<mx:DataGridColumn headerText="{languageArray['Date Administered']}"									dataField="dateAdmined"/>								<mx:DataGridColumn headerText="{languageArray['Notes']}"									dataField="notes"/>							</mx:columns>						</mx:DataGrid>					<mx:LinkButton label="{languageArray['Add new vaccination']}" color="#0000FF" click="showVaccCreateTitleWin()"/>		    	</mx:VBox>	      </mx:ViewStack>  		</mx:VBox>   	</mx:HBox></mx:VBox>
